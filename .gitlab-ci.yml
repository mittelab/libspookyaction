stages:
  - check
  - test
  - deploy

check format:
  stage: check
  image: alpine
  allow_failure: true
  before_script:
    - apk add --update --no-cache git clang
  script:
    - >
      find . \( -not -path '\./\.*' \) -and \( -name '*.[hc]' -or -name '*.[hc]pp' \) | while read -r FILE; do
          echo "Formatting $FILE"
          clang-format --style file -i "$FILE"
      done
    - git diff --patch | tee 0001-Clang-format.patch
    - test ! -s 0001-Clang-format.patch
  artifacts:
    paths:
      - 0001-Clang-format.patch
    expire_in: 1 week
    when: on_failure


.platformio-cache: &platformio-cache
  image: shaguarger/platformio:latest
  before_script:
    - PIO_FOLDERS=(packages platforms)
    - >
      function pio-restore-cache() {
        for PIO_FOLDER in "${PIO_FOLDERS[@]}"; do
          if [ -d ".pio-$PIO_FOLDER" ]; then
            echo "Restoring PlatformIO's $PIO_FOLDER"
            mv ".pio-$PIO_FOLDER" "/root/.platformio/$PIO_FOLDER"
          fi
        done
      }
    - >
      function pio-save-cache() {
        for PIO_FOLDER in "${PIO_FOLDERS[@]}"; do
          if [ -d "/root/.platformio/$PIO_FOLDER" ]; then
            echo "Saving PlatformIO's $PIO_FOLDER"
            mv "/root/.platformio/$PIO_FOLDER" ".pio-$PIO_FOLDER"
          fi
        done
      }
    - pio-restore-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .pio-packages
      - .pio-platforms
      - .pio

test examples:
  <<: *platformio-cache
  stage: test
  script:
    - >
      for file in examples/*; do
        pio ci \
          --lib="." \
          --board="m5stack-core-esp32" \
          -O "framework=espidf" \
          -O "platform=espressif32" \
          -O "test_build_project_src=yes" $file
      done
    - pio-save-cache


test hardware:
  <<: *platformio-cache
  stage: test
  script:
    - cp .platformio-ci.ini platformio.ini
    - pio project init
    - pio remote --agent testinator test --upload-port /dev/ttyUSB0 --test-port /dev/ttyUSB0
    - pio-save-cache
  rules:
    - if: "$PLATFORMIO_AUTH_TOKEN"


pages:
  stage: deploy
  image: alpine
  before_script:
    - apk add --update --no-cache doxygen
  script:
    - doxygen ./docs/doxigen.conf
    - mkdir -p public
    - cp -r docs/_build/html/* public
  artifacts:
    paths:
      - public
  only:
    - master
